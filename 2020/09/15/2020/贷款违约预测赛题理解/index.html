<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>贷款违约预测赛题理解 | LiuHDme</title>
  <meta name="author" content="LiuHDme">
  
  <meta name="description" content="本次的比赛的任务是二分类，即预测用户贷款是否会违约。数据为结构化数据，一共有 47 个特征，因此对特征如何筛选、优化、组合应该会对结果产生很大影响，后续的特征工程需要仔细开展。数据量上，train 有 80 万，testA 和 testB 各 20 万，数据量不算大，可以先用传统机器学习模型，后续再上深度学习模型，然后考虑模型融合。
比赛地址：https://tianchi.aliyun.com/competition/entrance/531830/introduction">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="贷款违约预测赛题理解"/>
  <meta property="og:site_name" content="LiuHDme"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/css/themes/cerulean.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight-default.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/comment.css" media="screen" type="text/css">
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.7/es5-sham.min.js"></script>
  <![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>
  
  <!-- analytics -->
  



<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <nav id="main-nav" class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">LiuHDme</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="所有文章">
			  <i class="fa fa-archive"></i>归档
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="所有标签">
			  <i class="fa fa-tags"></i>标签
			</a>
		  </li>
		  
		  <li>
			<a href="/photos" title="">
			  <i class="fa fa-camera"></i>相册
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="个人简介">
			  <i class="fa fa-user"></i>关于
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
    <div class="content">
      


	
		<div class="page-header page-header-inverse ">		
			<h1 class="title title-inverse "> 贷款违约预测赛题理解</h1>
		</div>		
	






<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p>本次的比赛的任务是二分类，即预测用户贷款是否会违约。数据为结构化数据，一共有 47 个特征，因此对特征如何筛选、优化、组合应该会对结果产生很大影响，后续的特征工程需要仔细开展。数据量上，train 有 80 万，testA 和 testB 各 20 万，数据量不算大，可以先用传统机器学习模型，后续再上深度学习模型，然后考虑模型融合。</p>
<p>比赛地址：<a target="_blank" rel="noopener" href="https://tianchi.aliyun.com/competition/entrance/531830/introduction">https://tianchi.aliyun.com/competition/entrance/531830/introduction</a></p>
<a id="more"></a>
<h2 id="指标"><a href="#指标" class="headerlink" title="指标"></a>指标</h2><p>这次赛题的指标是 AUC，AUC 越大，模型的预测性能越好，但 AUC 具体该如何计算，下面详细讲讲。</p>
<h3 id="AUC"><a href="#AUC" class="headerlink" title="AUC"></a>AUC</h3><p>AUC 就是 ROC 的曲线下面积，而 ROC 是根据 fpr 和 tpr 得到的，因此需要先了解 fpr 和 tpr 的概念。</p>
<p>fpr 和 tpr 的定义如下面两个式子所示：(tp: true positive, tn: true negative, fp: false positive, fn: false negative)</p>
<script type="math/tex; mode=display">
tpr = \frac{tp}{tp+fn}</script><script type="math/tex; mode=display">
fpr = \frac{fp}{fp+tn}</script><p>其中，tpr 也叫 recall，意义是把正样本预测为正样本占所有正样本的比例，fpr 的意义是把负样本预测成正样本占所有负样本的比例。在计算 AUC 前，需要先得到 ROC，而得到 ROC 需要得到 fpr 和 tpr，上面的代码通过调用 <code>sklearn.metrics.roc_curve</code> 来计算 fpr 和 tpr。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> metrics</span><br><span class="line">y = np.array([<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>])</span><br><span class="line">scores = np.array([<span class="number">0.1</span>, <span class="number">0.4</span>, <span class="number">0.35</span>, <span class="number">0.8</span>])</span><br><span class="line">fpr, tpr, thresholds = metrics.roc_curve(y, scores, pos_label=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>下面来模拟一下计算过程。</p>
<p>首先得到阈值为：<code>[1.8, 0.8, 0.4, 0.35, 0.1]</code>，即把最大预测值加 1 然后从大到小排序。</p>
<ol>
<li>阈值为 1.8 时，tp = 0, tn = 2, fp = 0, fn = 2，所以 tpr = 0, fpr = 0</li>
<li>阈值为 0.8 时，tp = 1, tn = 2, fp = 0, fn = 1，所以 tpr = 0.5, fpr = 0</li>
<li><p>阈值为 0.4 时，tp = 1, tn = 1, fp = 1, fn = 1，所以 tpr = 0.5, fpr = 0.5</p>
</li>
<li><p>阈值为 0.35 时，tp = 2, tn = 1, fp = 1, fn = 0，所以 tpr = 1, fpr = 0.5</p>
</li>
<li>阈值为 0.1 时，tp = 2, tn = 0, fp = 2, fn = 0，所以 tpr = 1, fpr = 1</li>
</ol>
<p>即最后有，<code>tpr = [0, 0.5, 0.5, 1, 1], fpr = [0, 0, 0.5, 0.5, 1]</code>，这和程序的输出是一致的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>fpr</span><br><span class="line">array([<span class="number">0.</span> , <span class="number">0.</span> , <span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">1.</span> ])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>tpr</span><br><span class="line">array([<span class="number">0.</span> , <span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">1.</span> , <span class="number">1.</span> ])</span><br></pre></td></tr></table></figure>
<p>根据上面的 tpr 和 fpr，可以画出 ROC 如下：</p>
<p><img src="http://liuhdme-blog.oss-cn-beijing.aliyuncs.com/2020-09-15-073418.png" style="zoom:50%;" /></p>
<p>可以看出 AUC 应该是 0.75，验证一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>metrics.roc_auc_score(y, scores)</span><br><span class="line"><span class="number">0.75</span></span><br></pre></td></tr></table></figure>
<p>确实如此。</p>
<hr>
<h3 id="PR-CUrve"><a href="#PR-CUrve" class="headerlink" title="PR-CUrve"></a>PR-CUrve</h3><p>和 ROC 类似的还有 PR 曲线，就是 precision-recall 曲线，precision 和 recall 的定义如下：</p>
<script type="math/tex; mode=display">
Precision = \frac{tp}{tp+fp}</script><script type="math/tex; mode=display">
Recall = \frac{tp}{tp+fn}</script><p>Recall 就是计算 ROC 时提到的 tpr，precision 的意义是，你预测为正样本的所有样本中，有多少真的是正样本。显然，如果把所有样本都预测为正样本，那 recall 取到最大值 1，而 precision 会降低，至于多低取决于负样本的数量，负样本越多 precision 越低。</p>
<p>下面的代码调用 <code>sklearn.metrics.precision_recall_curve</code> 得到不同阈值下的 precision 和 recall</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> precision_recall_curve</span><br><span class="line">y_true = np.array([<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>])</span><br><span class="line">y_scores = np.array([<span class="number">0.1</span>, <span class="number">0.4</span>, <span class="number">0.35</span>, <span class="number">0.8</span>])</span><br><span class="line">precision, recall, thresholds = precision_recall_curve(y_true, y_scores)</span><br></pre></td></tr></table></figure>
<p>下面模拟计算过程。</p>
<p>首先和 ROC 不同，这里阈值只取 <code>[0.35, 0.4, 0.8]</code>，即去掉最小值然后从小到大排。</p>
<ol>
<li><p>阈值为 0.35 时，tp = 2, tn = 1, fp = 1, fn = 0，所以 recall = 1, precision = 2/3</p>
</li>
<li><p>阈值为 0.4 时，tp = 1, tn = 1, fp = 1, fn = 1，所以 recall = 0.5, precision = 0.5</p>
</li>
<li><p>阈值为 0.8 时，tp = 1, tn = 2, fp = 0, fn = 1，所以 recall = 0.5, precision = 1</p>
</li>
<li><p>阈值结束，最后的 recall = 0, precision = 1</p>
<blockquote>
<p>根据 sklearn 文档：The last precision and recall values are 1. and 0. respectively and do not have a corresponding threshold. This ensures that the graph starts on the y axis.</p>
</blockquote>
</li>
</ol>
<p>最后有，<code>recall = [1, 0.5, 0.5, 0], precision = [2/3, 0.5, 1, 1]</code></p>
<p>画出 PR-curve 如下：</p>
<p><img src="http://liuhdme-blog.oss-cn-beijing.aliyuncs.com/2020-09-15-075807.png" style="zoom:50%;" /></p>
<p>ROC 有曲线下面积 AUC，PR-curve 也有类似的概念：AP，即 average precision，类似于 PR-curve 的曲线下面积。</p>
<hr>
<h3 id="Average-Precision"><a href="#Average-Precision" class="headerlink" title="Average Precision"></a>Average Precision</h3><p>PR-Curve 对应的 AP 的是一个值，计算方式如下：</p>
<script type="math/tex; mode=display">
AP = \sum_{n}(R_n - R_{n-1})P_n</script><p>其中 $R_n$ 表示第 $n$ 个阈值时的 recall，$P_n$ 表示第 $n$ 个阈值时的 precision</p>
<p>用刚刚计算的 PR-Curve 为例，计算其 AP 如下：</p>
<script type="math/tex; mode=display">
AP = (1-0.5) \times \frac{2}{3} + (0.5-0.5) \times 0.5 + (0.5-0) \times 1 ≈ 0.83</script><p>用 <code>sklearn.metrics.average_precision_score</code> 验证一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>y_true = np.array([<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y_scores = np.array([<span class="number">0.1</span>, <span class="number">0.4</span>, <span class="number">0.35</span>, <span class="number">0.8</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>average_precision_score(y_true, y_scores)</span><br><span class="line"><span class="number">0.8333333333333333</span></span><br></pre></td></tr></table></figure>
<p>确实如此。</p>
<p>仔细观察 AP 的计算式，可以发现这是对 PR-Curve 下面积的近似，比如上面的式子其实是在计算下图被框出来的部分的面积：</p>
<p><img src="http://liuhdme-blog.oss-cn-beijing.aliyuncs.com/2020-09-15-081631.jpg" style="zoom:25%;" /></p>
<hr>
<p>以上就是 ROC, AUC, PR-Curve 和 AP 的一些概念和计算细节，其中 AUC是 ROC 的曲线下面积，AP 是 PR-Curve 的下面积的近似，ROC 的纵轴是 tpr 也就是 recall，PR-Curve 的横轴是 recall，即 ROC 的纵轴和 PR-Curve 的横轴表示的量是相同的。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>[1] <a target="_blank" rel="noopener" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.roc_curve.html#sklearn.metrics.roc_curve">https://scikit-learn.org/stable/modules/generated/sklearn.metrics.roc_curve.html#sklearn.metrics.roc_curve</a></p>
<p>[2] <a target="_blank" rel="noopener" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.precision_recall_curve.html">https://scikit-learn.org/stable/modules/generated/sklearn.metrics.precision_recall_curve.html</a></p>
<p>[3] <a target="_blank" rel="noopener" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.average_precision_score.html#sklearn.metrics.average_precision_score">https://scikit-learn.org/stable/modules/generated/sklearn.metrics.average_precision_score.html#sklearn.metrics.average_precision_score</a></p>
	  
	</div>

	<!-- recommended posts -->
	

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
		
          <li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
        

        <li><a href="/archives"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/2020/02/17/2020/追本溯源，带你读懂图自编码器/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>

    <!-- share -->
    
        

        

    
	
	<!-- comment -->
	
<section id="comment">
  <h2 class="title">Comments</h2>
  
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2020-09-15 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/技术/">技术<span>36</span></a></li> <li><a href="/categories/技术/Machine-Learning/">Machine Learning<span>28</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Data-Competition/">Data Competition<span>1</span></a></li>
    </ul>
	</div>
	

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
			<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E6%8C%87%E6%A0%87"><span class="toc-article-text">指标</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#AUC"><span class="toc-article-text">AUC</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#PR-CUrve"><span class="toc-article-text">PR-CUrve</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Average-Precision"><span class="toc-article-text">Average Precision</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#References"><span class="toc-article-text">References</span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->



      
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        processEscapes: true
      }
    });
  </script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
        tex2jax: {
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
  </script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
          var all = MathJax.Hub.getAllJax(), i;
          for(i=0; i < all.length; i += 1) {
              all[i].SourceElement().parentNode.className += ' has-jax';
          }
      });
  </script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

    </div>
  </div>
  <div class="container-narrow">
    <footer> <p>
  &copy; 2021 LiuHDme
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
  </div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>


<!-- syntax highlighting -->


</body>
</html>